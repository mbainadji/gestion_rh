{% extends 'employees/base.html' %}

{% block title %}Tableau de bord RH{% endblock %}
{% block page_title %}Vue d'ensemble analytique{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Total Employees -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex items-center gap-5 transition-transform hover:scale-[1.02] duration-200">
        <div class="w-14 h-14 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center text-2xl">
            <i class="fas fa-users"></i>
        </div>
        <div>
            <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Total Employés</p>
            <h3 class="text-3xl font-bold text-slate-800">{{ total_employees }}</h3>
        </div>
    </div>

    <!-- Departments -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex items-center gap-5 transition-transform hover:scale-[1.02] duration-200">
        <div class="w-14 h-14 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center text-2xl">
            <i class="fas fa-building"></i>
        </div>
        <div>
            <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Départements</p>
            <h3 class="text-3xl font-bold text-slate-800">{{ departements.count }}</h3>
        </div>
    </div>

    <!-- Pending Leaves -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex items-center gap-5 transition-transform hover:scale-[1.02] duration-200">
        <div class="w-14 h-14 rounded-xl bg-rose-50 text-rose-600 flex items-center justify-center text-2xl">
            <i class="fas fa-calendar-day"></i>
        </div>
        <div>
            <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Congés en attente</p>
            <h3 class="text-3xl font-bold text-slate-800">{{ recent_conges.count }}</h3>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
    <!-- Department Distribution Table -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
            <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                <i class="fas fa-chart-pie text-primary-500"></i>
                Répartition par Département
            </h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50/50">
                        <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Département</th>
                        <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-right">Effectif</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for dep in departements %}
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="px-6 py-4">
                            <span class="font-medium text-slate-700">{{ dep.nom }}</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ dep.num_employees }} employés
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Leaves List -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
            <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                <i class="fas fa-clock-rotate-left text-primary-500"></i>
                Demandes de Congés
            </h2>
            <a href="{% url 'employees:conge_list' %}" class="text-sm font-medium text-primary-600 hover:text-primary-700 hover:underline">Voir tout</a>
        </div>
        <div class="p-4 space-y-4">
            {% for conge in recent_conges %}
            <div class="flex items-center gap-4 p-3 rounded-xl hover:bg-slate-50 transition-colors border border-transparent hover:border-slate-100">
                <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500">
                    <i class="fas fa-user text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-semibold text-slate-800 truncate">{{ conge.employe.prenom }} {{ conge.employe.nom }}</p>
                    <p class="text-xs text-slate-500">{{ conge.date_debut|date:"d M" }} - {{ conge.date_fin|date:"d M Y" }}</p>
                </div>
                <div class="text-right">
                    <span class="px-2 py-1 text-[10px] font-bold uppercase rounded bg-amber-100 text-amber-700">En attente</span>
                </div>
            </div>
            {% empty %}
            <div class="flex flex-col items-center justify-center py-12 text-center">
                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-slate-300 mb-4">
                    <i class="fas fa-calendar-xmark text-2xl"></i>
                </div>
                <p class="text-slate-500 font-medium">Aucune demande en attente</p>
                <p class="text-xs text-slate-400 mt-1">Tout est à jour !</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Chart Section -->
<div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mt-8">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
            <i class="fas fa-chart-line text-primary-500"></i>
            Évolution des effectifs
        </h2>
    </div>
    <div class="h-[350px] w-full">
        <canvas id="deptChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('deptChart').getContext('2d');
        
        // Create gradient for the bars
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(14, 165, 233, 0.8)');
        gradient.addColorStop(1, 'rgba(14, 165, 233, 0.2)');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [{% for dep in departements %}'{{ dep.nom }}',{% endfor %}],
                datasets: [{
                    label: 'Nombre d\'employés',
                    data: [{% for dep in departements %}{{ dep.num_employees }},{% endfor %}],
                    backgroundColor: gradient,
                    borderColor: '#0ea5e9',
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false,
                    barThickness: 40,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: '#f1f5f9',
                            drawBorder: false,
                        },
                        ticks: {
                            stepSize: 1,
                            color: '#64748b',
                            font: {
                                family: 'Inter',
                                size: 12
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                        },
                        ticks: {
                            color: '#64748b',
                            font: {
                                family: 'Inter',
                                size: 12
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        padding: 12,
                        titleFont: { size: 14, weight: 'bold', family: 'Inter' },
                        bodyFont: { size: 13, family: 'Inter' },
                        cornerRadius: 8,
                        displayColors: false
                    }
                }
            }
        });
    });
</script>
{% endblock %}
